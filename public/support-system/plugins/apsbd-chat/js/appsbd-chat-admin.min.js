(function(a){a.fn.appsbdAdminChat=function(c){var d=a.extend({text:"Hello, World!",url:"",color:null,userImage:"",userId:"",ajaxSender:null,checkInterval:3000,loadText:"Loading Please Wait..",cancelText:"Are you sure to close chat?",cancelUrl:"",audioPath:"",cannedMessages:[],maxFileSize:"2",maxFileErrorMsgTitle:"Large File Error",maxFileErrorMsg:"Max file size is  %s MB",unsupportedFileMsgTitle:"File Error",unsupportedFileMsg:"Uploaded file is not  supported",loadMoreText:"Load More",onNewChatOrMsg:function(f,e){},onDataBind:function(e){},onInit:function(e){},onResize:function(e){}},c);var b={id:"",temp_id:"",msg_html:"",msg_time:"",chatId:"",senderType:"",senderImg:""};return this.each(function(){function r(F){var E=JSON.stringify(F);return JSON.parse(E)}var n=a(this);var j=n;var q=n.find(".apc-user-list .apc-pnl-content");var e=n.find("ul.apc-chat-list");var B=n.find("ul.apc-chat-end-list");var i="";var v=null;if(i!=""){v=n.find("#"+i)}var C=true;var h=n.find(".apc-chat-item-msg-divider");var A=n.find(".apc-chat-msg-type-panel");var k=n.find(".apc-chat-msg-type-panel  textarea.apc-admin-chat-input");var t=A.height()+30;var z=t;var m=t;var x=m+300;var g=false;var D=n.find(".apc-chat-item-content");var l;var u=A.find(".apc-msg-typing");var p=[];var o=n.find(".apc-chat-user-info");var w=n.find("#chat-canned-msg");var f=n.find("#chat-canned-msg-btn");var y=n.find(".apc-attach-btn");var s=n.find(".apc-file-up-status");n.find(".apc-open-user-list").on("click",function(E){E.preventDefault();n.find(".apc-user-list").addClass("apc-show");n.find(".apc-chat-user-info").removeClass("apc-show")});n.find(".apc-open-chatinfo").on("click",function(E){E.preventDefault();n.find(".apc-user-list").removeClass("apc-show");n.find(".apc-chat-user-info").addClass("apc-show")});n.find(".apc-user-list .apc-close-btn").on("click",function(E){E.preventDefault();n.find(".apc-user-list").removeClass("apc-show")});n.find(".apc-chat-user-info .apc-close-btn").on("click",function(E){E.preventDefault();n.find(".apc-chat-user-info").removeClass("apc-show")});n.resize=function(){var H=n.offset();var G=a(window).height();var F=G-16-H.top;if(F<250){F=250}n.height(F);t=A.height()+30;var E=q.height()-20;q.find("div.apc-diver").height("20px");e.height(E/2);B.height(E-((E/2)+20));if(a.isFunction(d.onResize)){d.onResize(n)}};n.AddChatWindow=function(F){var E=n.find(".apc-chat-item-content").find("#chat_id_"+F);if(E.length==0){E=a('<div id="chat_id_'+F+'" style="display: none;" class="apc-msgs"><div class="apc-load-move text-center" data-chat-id="'+F+'" ><button class="btn btn-xs btn-info"><i class="fa fa-arrow-circle-o-down"></i> '+d.loadMoreText+"</button></div></div>");n.find(".apc-chat-item-content").append(E)}return E};n.SetChatLiEvent=function(E){E.on("click",function(F){F.preventDefault();chatId=a(this).data("chatid");n.SetCurrentChatId(chatId)})};n.setLoadMore=function(){try{if(v.find(".apc-item").length>0){var F=v.find(".apc-item:first").data("msg-id");if(F!="AAAA"){v.find(".apc-load-move").show()}else{v.find(".apc-load-move").hide()}}}catch(E){}};n.AddNewChat=function(F){var E=e.find("#btn-chat-"+F.id);if(E.length==0){if(typeof d.onNewChatOrMsg=="function"){try{d.onNewChatOrMsg(F,"C")}catch(G){}}E=a('<li id="btn-chat-'+F.id+'" data-istyping="'+F.is_user_typing+'" data-chatid="'+F.id+'"><span class="name">'+F.open_user_title+'</span><span class="apc-rtc-c badge"><span class="apc-btn-rc">0</span></span></li>');e.append(E);n.SetChatLiEvent(E);p[F.id]={}}else{E.find(".name").text(F.open_user_title)}p[F.id]=F;a("#btn-chat-"+F.id).data("istyping",F.is_user_typing);return n.AddChatWindow(F.id)};n.AddEndChat=function(F){var E=B.find("#btn-chat-"+F.id);try{var G=e.find("#btn-chat-"+F.id);if(G.length>0){if(G.hasClass("apc-active")){n.SetCurrentChatId("")}D.find("#chat_id_"+F.id).hide();e.find("#btn-chat-"+F.id).remove()}}catch(H){}if(E.length==0){E=a('<li id="btn-chat-'+F.id+'" data-istyping="'+F.is_user_typing+'" data-chatid="'+F.id+'"><span class="name">'+F.open_user_title+'</span> <span class="apc-rtc-c badge"><span class="apc-btn-rc">0</span></span></li>');B.prepend(E);n.SetChatLiEvent(E);p[F.id]={}}else{E.find(".name").text(F.open_user_title)}p[F.id]=F;a("#btn-chat-"+F.id).data("istyping",F.is_user_typing);return n.AddChatWindow(F.id)};n.SetCurrentChatId=function(F){i=F;if(i==""){n.find(".apc-chat-title").html("");n.find(".apc-chat-desi").html("");o.find("#dd-name").text("");o.find("#dd-ip").text("");o.find("#dd-start-time").text("");o.find("#dd-country").text("");o.find("#dd-browser").text("");o.find("#dd-end-time .chat-end-button").hide();o.find("#dd-end-time .endtimestr").text("").show();n.ResetTyping();return}v=n.find("#chat_id_"+i);if(v.length==0){v=n.AddChatWindow(F)}v.show();e.find("> li:not(#btn-chat-"+i+")").removeClass("apc-active");B.find("> li:not(#btn-chat-"+i+")").removeClass("apc-active");var H=a("#btn-chat-"+i);H.removeClass("has-msg").addClass("apc-active");var E=H.find(".apc-btn-rc");if(E!==undefined){E.text("0")}n.find(".apc-msgs:not(#chat_id_"+i+")").hide();n.checkCurrentTyping();try{n.find(".apc-chat-title").html(p[i].open_user_title);n.find(".apc-chat-desi").html("IP:"+p[i].ip);o.find("#dd-name").text(p[i].open_user_title);o.find("#dd-ip").text(p[i].ip);o.find("#dd-start-time").text(p[i].start_time);o.find("#dd-country").text(p[i].country);o.find("#dd-browser").text(p[i].bw_name);if(p[i].status=="C"){o.find("#dd-end-time .chat-end-button").hide();o.find("#dd-end-time .endtimestr").text(p[i].end_time).show()}else{o.find("#dd-end-time .chat-end-button").data("chat_id",i).show();o.find("#dd-end-time .endtimestr").hide().text("")}if(p[i].status=="C"){k.prop("disabled",true)}else{k.prop("disabled",false)}n.ResetTyping()}catch(G){}j.setLoadMore()};n.ShowLoading=function(F,G){if(typeof G=="undefined"){G=d.loadText}var E=n.find(".apc-loading");if(F){E.find(".apc-loading-msg").html(G);E.fadeIn()}else{E.fadeOut()}};n.ScrollToDown=function(E){if(typeof E=="undefined"){E=v}var F=E.prop("scrollHeight");E.scrollTop(F)};n.SendMsg=function(H,E){if(H==""){return}var F=r(b);var G=new Date();F.temp_id=d.userId+G.getTime();F.id="";F.msg_html=H.replace(/[\u00A0-\u9999<>\'\"\&\\]/gim,function(I){return"&#"+I.charCodeAt(0)+";"});F.senderType=E?"A":"C";F.senderImg=d.userImage;n.AppendMessage(F,F.senderType);n.PostAdmin({topic:"newentry",newEntry:F,isFirstLoad:false},function(J,I){n.processData(J)},function(I){},function(I){})};n.processData=function(H){var K=i=="";try{if(H.currentItem){var I=a("#"+H.currentItem.temp_id);if(I.length>0){I.find(".apc-sending").html(H.currentItem.msg_time)}}}catch(J){}try{if(H.chatEndlist&&H.chatEndlist.length>0){for(var G in H.chatEndlist){var L=n.AddEndChat(H.chatEndlist[G]);if(H.chatEndlist[G].msgs&&H.chatEndlist[G].msgs.length>0){for(var E=H.chatEndlist[G].msgs.length-1;E>=0;E--){n.AppendNewMessage(H.chatEndlist[G].msgs[E],H.chatEndlist[G].msgs[E].senderType,true,L)}}}}}catch(J){}try{if(H.chatlist&&H.chatlist.length>0){for(var G in H.chatlist){var L=n.AddNewChat(H.chatlist[G]);if(i==""){i=H.chatlist[G].id}if(H.chatlist[G].msgs&&H.chatlist[G].msgs.length>0){for(var E=H.chatlist[G].msgs.length-1;E>=0;E--){n.AppendNewMessage(H.chatlist[G].msgs[E],H.chatlist[G].msgs[E].senderType,true,L)}}}}if(K){n.SetCurrentChatId(i)}if(C){C=false;n.ShowLoading(false);n.StartChecking()}n.checkCurrentTyping();j.setLoadMore()}catch(F){gcl(F)}};n.checkCurrentTyping=function(){if(a("#btn-chat-"+i).data("istyping")=="Y"){u.show()}else{u.hide()}};n.LoadChatData=function(){if(d.url==""){return}n.PostAdmin({topic:"checking",isFirstLoad:C},function(F,E){n.processData(F);C=false},function(E){},function(E){})};n.SetMeTyping=function(E){g=E};n.StopChecking=function(){try{clearInterval(l)}catch(E){}};n.StartChecking=function(){n.StopChecking();l=setInterval(n.LoadChatData,d.checkInterval)};n.SaveLastRequestTime=function(){};j.SendFile=function(F,E,G,K,J,L){var H=a("<form>");H.append(E.clone());H.append('<input value="attach" type="hidden" name="topic">');H.append('<input value="'+i+'" type="hidden" name="chatId">');var I=new FormData(H[0]);a.ajax({type:"post",url:F,data:I,dataType:"json",beforeSend:function(){if(G!==undefined&&typeof G=="function"){G()}},success:function(M){if(L!==undefined&&typeof L=="function"){L(M)}},xhr:function(){var M=a.ajaxSettings.xhr();M.upload.onprogress=function(N){var O=(N.loaded/N.total*100);if(J!==undefined&&typeof J=="function"){J(O,N.loaded,N.total)}};M.upload.onload=function(){if(K!==undefined&&typeof K=="function"){K()}};return M},processData:false,contentType:false})};n.PostAdmin=function(G,E,F,H){G=a.extend({currentChatId:i,userId:d.userId,isUserTyping:g},G);d.onDataBind(G);if(d.ajaxSender&&typeof(d.ajaxSender)=="function"){d.ajaxSender(G,E,F,H);return}if(d.url==""){return}a.ajax({type:"POST",url:d.url,data:G,dataType:"json",cache:false,async:true,beforeSend:function(){n.StopChecking();n.SaveLastRequestTime();if(typeof F=="function"){F(G)}},success:function(I){n.StartChecking();if(typeof E=="function"){E(I,G);return}},complete:function(){n.StartChecking();if(typeof H=="function"){H(G);return}}})};n.ResetTyping=function(){k.val("");k.trigger("keyup");k.focus();n.SetMeTyping(false)};n.AppendMessage=function(H,F,E){var G="S";if(F){G="A"}n.AppendNewMessage(H,G,E,v)};n.GetNewMessageHtml=function(K,G,L){if(typeof(G)=="undefined"){G="S"}if(L===undefined){L=true}var M=G=="A"?"apc-me":"";var J,E;if(G=="S"){E="";J="apc-msg-sys-item"}else{J="apc-msg-item";E='<div class="apc-umg"><img src="'+K.senderImg+'" alt="Chatimg"></div>'}if(K.msg_html.match(/</)&&K.msg_html.match(/>/)){var H=K.msg_html.replace(/\-\-sessionkey\-\-/gim,"admin")}else{var H=n.linkify(K.msg_html+"");H=H.replace("\n","<br />")}var I='<span class="apc-sending">'+(G=="A"&&!L?'<i class="fa fa-spin fa-circle-o-notch"></i></span>':K.msg_time);var F=' <div id="'+K.temp_id+'" data-msg-id="'+K.id+'" class="apc-item animated fadeIn '+J+" "+M+'">'+E+'                        <div class="apc-msg">'+H+'                        </div><div class="apc-msg-time"> '+I+"</div>                    </div>";return F};n.AppendNewMessage=function(J,H,K,M,F){if(F==undefined){F=true}if(a("#"+J.temp_id).length>0){}else{M.append(n.GetNewMessageHtml(J,H,K));if(typeof d.onNewChatOrMsg=="function"){try{d.onNewChatOrMsg(J,"M")}catch(I){}}if(!C){var N=a("li#btn-chat-"+J.chatId);if(!N.hasClass("apc-active")){var E=N.find(".apc-btn-rc");if(!N.hasClass("has-msg")){N.addClass("has-msg")}if(E!==undefined){var L=parseInt(E.text());E.text(L+1)}}}n.ScrollToDown(M);if(H=="A"){n.ResetTyping()}else{if(!C&&F&&d.audioPath!=""){var G=new Audio(d.audioPath);G.play()}}n.SetContentEvent()}};n.linkify=function(H){var F=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim;var G=/(^|[^\/])(www\.[\S]+(\b|$))/gim;var E=/[\w.]+@[a-zA-Z_-]+?(?:\.[a-zA-Z]{2,6})+/gim;return H.replace(F,'<a target="_blank" href="$&">$&</a>').replace(G,'$1<a target="_blank" href="http://$2">$2</a>').replace(E,'<a target="_blank" href="mailto:$&">$&</a>')};n.SetContentEvent=function(){try{a(".apc-chat-img:not(.added-p)").magnificPopup({type:"image",mainClass:"mfp-with-zoom",zoom:{enabled:true,duration:300,easing:"ease-in-out",opener:function(F){return F.is("img")?F:F.find("img")}}}).addClass("added-p")}catch(E){console.log(E)}};n.AddloadMoreMessageData=function(I,E){var H=E.find(".apc-load-move");for(var G in I){var F=n.GetNewMessageHtml(I[G],I[G].senderType,true);if(F!=""){H.after(F)}}j.SetContentEvent();j.setLoadMore()};n.FileStatusViewer=function(F,E){if(E==undefined){E=F!=""}if(E){s.html(F).show()}else{s.html(F).hide()}};n.init=function(){n.resize();a(window).on("resize",function(H){n.resize()});try{e.slimScroll();B.slimScroll()}catch(G){}function E(K){var J={};J.pageX0=K.pageX;J.pageY0=K.pageY;J.elem=this;J.offset0=a(this).offset();function I(L){z=t+((J.pageY0-L.pageY)*1.5)+30;if(z<m){z=m}else{if(z>x){z=x}}A.height(z)}function H(L){t=z;a("body").off("mousemove",I).off("mouseup",H)}a("body").on("mouseup",H).on("mousemove",I)}k.on("keypress",function(I){var H=I.which;if(!I.shiftKey&&H==13){I.preventDefault();var J=k.val();n.SendMsg(J,true);k.val("")}});k.on("keyup",function(H){var I=k.val();if(I.length>0){n.SetMeTyping(true);y.hide()}else{y.show();n.SetMeTyping(false)}});n.AlertMessageViewer=function(M,H,J,L,I,K){ShowGritterMsg(M,H,J,L,I)};n.sprintf=function(I){for(var H=1;H<arguments.length;H++){I=I.replace(/%s/i,arguments[H])}return I};n.find(".apc-send-btn").on("click",function(H){H.preventDefault();var I=k.val();n.SendMsg(I);k.val("")});n.on("click",".apc-load-move",function(L){try{var N=a(this);var J=N.closest(".apc-msgs");var K=J.find(".apc-item:first").data("msg-id");var M=N.data("chat-id");var I=N.find("> button i");var H=I.attr("class");j.PostAdmin({topic:"loadmore",currentChatId:M,last_msg_id:K},function(P,O){j.AddloadMoreMessageData(P,J)},function(O){N.find("> button i").attr("class","fa fa-spin fa-refresh")},function(){N.find("> button i").attr("class",H)})}catch(L){}});y.on("click",function(H){H.preventDefault();if(!d.isDisableFileUpload&&d.url!=""){a('<input type="file" name="attach_file" accept="'+d.fileAccepts+'">').on("change",function(M){var L=d.maxFileSize*1024*1024;var N=this.files[0].name.substr(-4);var K=a(this).attr("accept");var I=K.indexOf(N)!=-1;if(L<this.files[0].size){j.AlertMessageViewer(j.sprintf(d.maxFileErrorMsg,d.maxFileSize),false,false,d.maxFileErrorMsgTitle,"times-circle-o")}else{if(!I){j.AlertMessageViewer(d.unsupportedFileMsg,false,false,d.unsupportedFileMsgTitle,"times-circle-o")}else{var J=this.files[0].name;if(J.length>10){J=J.substr(0,5)+".."+J.substr(-5)}j.SendFile(d.url,a(this),function(){j.FileStatusViewer(J+" uploading(0%)")},function(){j.FileStatusViewer(J+" processing..")},function(P,O,Q){j.FileStatusViewer(J+" uploading("+P.toFixed(0)+"%)")},function(O){if(!O.attach_status){j.AlertMessageViewer(O.attach_msg,false)}j.FileStatusViewer("",false);j.processData(O);setTimeout(j.ScrollToDown(),500)})}}}).trigger("click")}});n.LoadChatData();o.find("#dd-end-time .chat-end-button").on("click",function(I){I.preventDefault();var J=a(this).data("chat_id");var H=a(this);if(d.cancelUrl==""){alert("Cancel url is empty");return}if(confirm(d.cancelText)){a.getJSON(d.cancelUrl,{chat_id:J},function(K){if(K.status){H.hide()}ShowGritterMsg(K.msg,K.status,K.is_sticky,K.title,K.icon)})}});if(d.cannedMessages.length>0){for(var F in d.cannedMessages){w.append('<option value="'+F+'">'+d.cannedMessages[F].title+"</option>")}}f.on("click",function(H){H.preventDefault();var I=w.val();if(I==""){alert("Please choose canned message first");return}try{n.SendMsg(d.cannedMessages[I].canned_msg,true);w.val("")}catch(H){console.log(H)}});if(a.isFunction(d.onInit)){d.onInit(n)}return n};return n.init()})}}(jQuery));